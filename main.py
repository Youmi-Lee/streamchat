import streamlit as st
import openai

# OpenAI 클라이언트 초기화 (환경변수 OPENAI_API_KEY 필요)
client = openai.OpenAI()

# -------------------------
# 📌 평가 프롬프트 정의
# -------------------------
EVAL_PROMPT = """
너는 초등학교 글쓰기 평가 전문가이자 한국어 교정 전문가이다.  
학생의 글을 다음 기준에 따라 평가하고 피드백을 제공하라.  

[평가 기준]

1. 내용 이해 (독도 인식, 역사·자연·의미)  
- 4: 역사·자연·문화 가치를 폭넓게 이해하고 다양한 관점으로 표현  
- 3: 구체적 예시를 들어 중요성을 설명  
- 2: 중요성을 단순 언급  
- 1: 의미가 모호하거나 오해  

2. 사고력·창의성 (독자적 시각, 설득력)  
- 4: 독창적 관점과 설득력 있는 전개  
- 3: 부분적으로 새로움·설득 요소  
- 2: 일반적이고 단순한 의견  
- 1: 자기 생각이나 주장이 거의 없음  

3. 구성·조직력 (글의 구조, 논리 흐름)  
- 4: 도입–전개–결론이 명확하고 논리적 연결 뛰어남  
- 3: 구조가 있으나 반복·연결 약함  
- 2: 구조 불분명하거나 흐름이 산만  
- 1: 흐름이 산만하고 구조 거의 없음  

4. 표현력·문장력 (어휘, 맞춤법, 문장 다양성)  
- 4: 어휘·문장 풍부하고 맞춤법 오류 거의 없음  
- 3: 전반적으로 정확하나 일부 오류 있음  
- 2: 표현이 반복되고 맞춤법 오류 다수  
- 1: 표현 미흡하여 이해 어려움  

5. 태도·성실성 (분량, 주제 성실성)  
- 4: 분량 충실, 주제를 끝까지 성실히 다룸  
- 3: 분량 적절, 대체로 주제 일치  
- 2: 분량 부족하거나 주제 일부 이탈  
- 1: 분량 부족, 주제와 크게 벗어남  

[피드백 지침]  

1. 첨삭:  
- “원문 → 수정안” 형식으로 제시하고, 고친 이유도 반드시 설명한다.  
- 맞춤법, 띄어쓰기, 문법 오류를 빠짐없이 교정한다.  

2. 잘한 점:  
- 구체적 사례를 인용하며 칭찬한다.  
- “잘했어” 같은 추상적 표현은 사용하지 않는다.  

3. 보완할 점:  
- 부족한 점을 지적하는 데 그치지 않고, “무엇을 어떻게 고치면 좋은지” 구체적 대안을 제시한다.  

[출력 형식]  
  1. 평가 결과 (평가 기준에 따라 A+, A0, B+, B0, C+, C0, D+, D0, F)로 알려줘.
  2. 첨삭 (잘못된 부분과 수정안, 수정 이유)  
  3. 잘한 점 (구체적 사례 기반)  
  4. 보완할 점 (구체적 대안 포함)  
"""

# -------------------------
# 📌 Streamlit UI
# -------------------------
st.set_page_config(page_title="독도 글쓰기 평가 서비스", layout="centered")

st.title("📝 독도 주제 글쓰기 평가 서비스")
st.write("학생이 작성한 글을 입력하면 AI가 평가와 피드백을 제공합니다.")

student_text = st.text_area("✍️ 학생 글 입력", height=300, placeholder="여기에 독도 주제 글을 작성하세요...")

if st.button("평가하기"):
    if not student_text.strip():
        st.warning("학생 글을 입력해주세요.")
    else:
        with st.spinner("AI가 글을 분석 중입니다... ⏳"):
            response = client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": EVAL_PROMPT},
                    {"role": "user", "content": student_text}
                ],
                temperature=0.7
            )

            result = response.choices[0].message.content

        st.subheader("📊 평가 결과")
        st.write(result)
